# Copyright(C) 2024-2025 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: Test RAG

on:
  push:
    branches: [ main ]
    paths:
      - 'src/gaia/**'
      - 'tests/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/gaia/**'
      - 'tests/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-rag-unit:
    name: RAG Unit Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Free disk space
      uses: ./.github/actions/free-disk-space

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,rag]
        pip install pytest pytest-cov

    - name: Run RAG unit tests
      run: |
        echo "Running RAG unit tests..."
        pytest tests/test_rag.py -v -s --tb=short --cov=src/gaia/rag --cov-report=term-missing

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rag-unit-test-coverage
        path: .coverage

  test-rag-integration:
    name: RAG Integration Tests
    runs-on: [stx, miniforge]
    needs: test-rag-unit

    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,rag]
        pip install pytest reportlab

    - name: Install Lemonade Server
      uses: ./.github/actions/install-lemonade

    - name: Start Lemonade Server and Run Tests
      shell: powershell
      run: |
        # Set console to UTF-8 for Unicode support
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUTF8 = "1"
        chcp 65001 | Out-Null

        try {
            Write-Host "Starting Lemonade server..."
            $serverJob = Start-Job -ScriptBlock {
                & lemonade-server serve --host localhost --port 8000 --no-tray 2>&1
            }
            Write-Host "Started Lemonade server job with ID: $($serverJob.Id)"
            $env:LEMONADE_JOB_ID = $serverJob.Id

            # Wait for server to be ready
            Write-Host "Waiting for Lemonade server to start..."
            $maxWaitTime = 60
            $waitTime = 0
            $serverReady = $false

            while ($waitTime -lt $maxWaitTime -and -not $serverReady) {
                Start-Sleep -Seconds 2
                $waitTime += 2

                try {
                    $response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/health" -Method GET -TimeoutSec 5
                    Write-Host "[OK] Lemonade server is ready"
                    Write-Host "Health response: $($response | ConvertTo-Json -Compress)"
                    $serverReady = $true
                } catch {
                    Write-Host "Waiting... ($waitTime/$maxWaitTime seconds)"
                }
            }

            if (-not $serverReady) {
                Write-Host "[ERROR] Server health check failed after $maxWaitTime seconds"
                throw "Server failed to start"
            }

            # Pull required models (actual models used in RAG tests)
            Write-Host "`n=== Pulling Required Models ==="

            # Pull LLM model
            Write-Host "Pulling Qwen3-0.6B-GGUF..."
            try {
                $body = @{ model_name = "Qwen3-0.6B-GGUF" } | ConvertTo-Json
                $response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/pull" `
                    -Method POST -ContentType "application/json" -Body $body -TimeoutSec 600
                Write-Host "   [OK] Qwen3-0.6B-GGUF pull initiated"
            } catch {
                Write-Host "   [WARN] Pull may have failed: $($_.Exception.Message)"
            }

            # Pull embedding model (actual RAG default)
            Write-Host "Pulling nomic-embed-text-v2-moe-GGUF..."
            try {
                $body = @{ model_name = "nomic-embed-text-v2-moe-GGUF" } | ConvertTo-Json
                $response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/pull" `
                    -Method POST -ContentType "application/json" -Body $body -TimeoutSec 600
                Write-Host "   [OK] nomic-embed-text-v2-moe-GGUF pull initiated"
            } catch {
                Write-Host "   [WARN] Pull may have failed: $($_.Exception.Message)"
            }

            # Pull VLM model (for PDFs with images)
            Write-Host "Pulling Qwen2.5-VL-7B-Instruct-GGUF..."
            try {
                $body = @{ model_name = "Qwen2.5-VL-7B-Instruct-GGUF" } | ConvertTo-Json
                $response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/pull" `
                    -Method POST -ContentType "application/json" -Body $body -TimeoutSec 1200
                Write-Host "   [OK] Qwen2.5-VL-7B-Instruct-GGUF pull initiated"
            } catch {
                Write-Host "   [WARN] Pull may have failed: $($_.Exception.Message)"
            }

            # Wait for models to be available (longer wait for larger models)
            Write-Host "`nWaiting 30 seconds for models to be available..."
            Start-Sleep -Seconds 30

            # Verify models
            try {
                $models = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/models" -Method GET
                Write-Host "`n[OK] Available models:"
                $models.data | ForEach-Object { Write-Host "   - $($_.id)" }
            } catch {
                Write-Host "[WARN] Could not list models: $($_.Exception.Message)"
            }

            # Run tests in same session while server is running
            Write-Host "`n=== Running RAG Integration Tests ==="
            python tests/test_rag_integration.py
            $testExitCode = $LASTEXITCODE

            Write-Host "`nTests completed with exit code: $testExitCode"

            if ($testExitCode -ne 0) {
                throw "Tests failed with exit code $testExitCode"
            }
        } finally {
            # Always cleanup server
            if ($env:LEMONADE_JOB_ID) {
                Write-Host "`n=== Stopping Lemonade Server ==="
                Stop-Job -Id $env:LEMONADE_JOB_ID -ErrorAction SilentlyContinue
                Remove-Job -Id $env:LEMONADE_JOB_ID -ErrorAction SilentlyContinue
                Write-Host "[OK] Server stopped"
            }
        }

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rag-integration-test-results
        path: |
          pytest-results/
          *.log
