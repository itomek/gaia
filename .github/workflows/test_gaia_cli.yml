# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

# Main GAIA CLI testing workflow that coordinates platform-specific tests
# This workflow calls both Windows (full integration) and Linux (Lemonade-independent) tests
# Platform Coverage: Windows (full) + Linux (partial) + cross-platform validation

name: GAIA CLI Tests (All Platforms)

on:
  # Only run via workflow_call or manual dispatch
  # Individual child workflows (test_unit.yml, test_code_agent.yml, etc.) trigger
  # on push/pull_request independently - this avoids duplicate/conflicting runs
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

# Group concurrent runs but don't cancel - child workflows have their own concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run linting first (fast feedback)
  lint:
    name: Code Quality (Linting)
    uses: ./.github/workflows/lint.yml

  # Run unit tests second (fast, no external dependencies)
  unit-tests:
    name: Unit Tests (Fast)
    needs: lint
    uses: ./.github/workflows/test_unit.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Note: Lemonade Server Smoke Test runs as standalone workflow (test_lemonade_server.yml)
  # It's not called here to avoid duplicate runs on self-hosted [stx] runner

  # Test Windows CLI with full Lemonade integration
  test-windows:
    name: Windows CLI Tests (Full Integration)
    needs: lint
    uses: ./.github/workflows/test_gaia_cli_windows.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Test Linux CLI with full Lemonade integration
  test-linux:
    name: Linux CLI Tests (Full Integration)
    needs: lint
    uses: ./.github/workflows/test_gaia_cli_linux.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Test MCP Bridge functionality
  test-mcp:
    name: MCP Bridge Tests
    needs: lint
    uses: ./.github/workflows/test_mcp.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Test Code Agent functionality
  test-code-agent:
    name: Code Agent Tests
    needs: lint
    uses: ./.github/workflows/test_code_agent.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Test Chat Agent functionality
  test-chat-agent:
    name: Chat Agent Tests
    needs: lint
    uses: ./.github/workflows/test_chat_agent.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Test Security features
  test-security:
    name: Security Tests
    needs: lint
    uses: ./.github/workflows/test_security.yml
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

  # Summary job that reports overall status
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, test-windows, test-linux, test-mcp, test-code-agent, test-chat-agent, test-security]
    # Run always except when workflow or any dependency is cancelled (e.g., by cancel-in-progress)
    if: >-
      ${{ always() && !cancelled() &&
          needs.lint.result != 'cancelled' &&
          needs.unit-tests.result != 'cancelled' &&
          needs.test-windows.result != 'cancelled' &&
          needs.test-linux.result != 'cancelled' &&
          needs.test-mcp.result != 'cancelled' &&
          needs.test-code-agent.result != 'cancelled' &&
          needs.test-chat-agent.result != 'cancelled' &&
          needs.test-security.result != 'cancelled' }}
    steps:
      - name: Check test results
        run: |
          echo "=== GAIA CLI Test Summary ==="
          echo "Lint Status: ${{ needs.lint.result }}"
          echo "Unit Tests Status: ${{ needs.unit-tests.result }}"
          echo "Windows Tests Status: ${{ needs.test-windows.result }}"
          echo "Linux Tests Status: ${{ needs.test-linux.result }}"
          echo "MCP Tests Status: ${{ needs.test-mcp.result }}"
          echo "Code Agent Tests Status: ${{ needs.test-code-agent.result }}"
          echo "Chat Agent Tests Status: ${{ needs.test-chat-agent.result }}"
          echo "Security Tests Status: ${{ needs.test-security.result }}"
          echo ""

          # Check if all tests were skipped (draft PR without ready_for_ci label)
          if [[ "${{ needs.lint.result }}" == "skipped" &&
                "${{ needs.unit-tests.result }}" == "skipped" &&
                "${{ needs.test-windows.result }}" == "skipped" &&
                "${{ needs.test-linux.result }}" == "skipped" &&
                "${{ needs.test-mcp.result }}" == "skipped" &&
                "${{ needs.test-code-agent.result }}" == "skipped" &&
                "${{ needs.test-chat-agent.result }}" == "skipped" &&
                "${{ needs.test-security.result }}" == "skipped" ]]; then
            echo "â­ï¸ All tests skipped (draft PR - add 'ready_for_ci' label to run)"
            exit 0
          fi

          # Check if all integration tests were skipped/cancelled (workflow cancelled early)
          if [[ "${{ needs.unit-tests.result }}" == "skipped" &&
                "${{ needs.test-windows.result }}" == "skipped" &&
                "${{ needs.test-linux.result }}" == "skipped" &&
                "${{ needs.test-mcp.result }}" == "skipped" &&
                "${{ needs.test-code-agent.result }}" == "skipped" &&
                "${{ needs.test-chat-agent.result }}" == "skipped" &&
                "${{ needs.test-security.result }}" == "skipped" ]]; then
            echo "â­ï¸ Workflow cancelled or lint failed - no integration tests ran"
            exit 0
          fi

          # Helper function to check if result is acceptable (success or skipped)
          check_result() {
            [[ "$1" == "success" || "$1" == "skipped" ]]
          }

          # Determine overall status (success or skipped are both acceptable)
          if check_result "${{ needs.lint.result }}" &&
             check_result "${{ needs.unit-tests.result }}" &&
             check_result "${{ needs.test-windows.result }}" &&
             check_result "${{ needs.test-linux.result }}" &&
             check_result "${{ needs.test-mcp.result }}" &&
             check_result "${{ needs.test-code-agent.result }}" &&
             check_result "${{ needs.test-chat-agent.result }}" &&
             check_result "${{ needs.test-security.result }}"; then
            echo "âœ… All tests passed!"
            echo "- Unit Tests: Fast SDK component tests (DatabaseMixin, LLM, ASR, TTS)"
            echo "- Windows: Full CLI functionality with Lemonade integration"
            echo "- Linux: Full CLI functionality with Lemonade integration"
            echo "- MCP: HTTP-native bridge and protocol compliance"
            echo "- Code Agent: Autonomous code generation and modification"
            echo "- Chat Agent: Session persistence and chat history"
            echo "- Security: Path validation and shell injection prevention"
            echo "- Cross-platform: Code quality and compatibility"
          else
            echo "âŒ Some tests failed:"
            [[ "${{ needs.lint.result }}" == "failure" ]] && echo "  - Linting failed"
            [[ "${{ needs.unit-tests.result }}" == "failure" ]] && echo "  - Unit tests failed"
            [[ "${{ needs.test-windows.result }}" == "failure" ]] && echo "  - Windows tests failed"
            [[ "${{ needs.test-linux.result }}" == "failure" ]] && echo "  - Linux tests failed"
            [[ "${{ needs.test-mcp.result }}" == "failure" ]] && echo "  - MCP tests failed"
            [[ "${{ needs.test-code-agent.result }}" == "failure" ]] && echo "  - Code Agent tests failed"
            [[ "${{ needs.test-chat-agent.result }}" == "failure" ]] && echo "  - Chat Agent tests failed"
            [[ "${{ needs.test-security.result }}" == "failure" ]] && echo "  - Security tests failed"
            exit 1
          fi

      - name: Report test coverage
        run: |
          echo ""
          echo "=== Test Coverage by Platform ==="
          echo "ğŸ”Œ Lemonade Server (Smoke Test):"
          echo "  âœ… Health endpoint verification"
          echo "  âœ… Models endpoint verification"
          echo "  âœ… Basic inference test"
          echo ""
          echo "âš¡ Unit Tests (Fast, No Dependencies):"
          echo "  âœ… DatabaseMixin: SQLite database access for agents"
          echo "  âœ… LLM Client: Language model client utilities"
          echo "  âœ… ASR: Automatic speech recognition utilities"
          echo "  âœ… TTS: Text-to-speech utilities"
          echo ""
          echo "ğŸªŸ Windows (Full Integration):"
          echo "  âœ… CLI installation and setup"
          echo "  âœ… Lemonade server integration"
          echo "  âœ… Core commands (chat, prompt, llm)"
          echo "  âœ… Audio features (talk command)"
          echo "  âœ… Evaluation tools"
          echo "  âœ… Summarizer CLI integration"
          echo "  âœ… Process management"
          echo ""
          echo "ğŸ§ Linux (Full Integration):"
          echo "  âœ… CLI installation and setup"
          echo "  âœ… Lemonade server with Gemma model"
          echo "  âœ… Core commands (chat, prompt, llm)"
          echo "  âœ… Evaluation tools (eval, groundtruth, report)"
          echo "  âœ… Summarizer CLI integration"
          echo "  âœ… Cross-platform process management"
          echo "  âœ… Python import compatibility"
          echo ""
          echo "ğŸŒ MCP Bridge (Cross-Platform):"
          echo "  âœ… HTTP-native bridge server"
          echo "  âœ… JSON-RPC protocol compliance"
          echo "  âœ… LLM agent integration"
          echo "  âœ… Tool registration and discovery"
          echo "  âœ… Error handling and recovery"
          echo "  âœ… CORS support for browser clients"
          echo "  â­ï¸  Jira integration (skipped - requires auth)"
          echo ""
          echo "ğŸ”’ Security Tests (Cross-Platform):"
          echo "  âœ… Path traversal prevention (PathValidator)"
          echo "  âœ… Shell command injection prevention"
          echo "  âœ… Agent security boundary enforcement"
          echo "  âœ… Argument sanitization"
          echo "  âœ… Access control validation"
          echo "  âœ… Windows and Linux security verification"
          echo ""
          echo "ğŸ‰ Full Platform Support Achieved!"
          echo "  ğŸ”§ Future enhancements:"
          echo "  ğŸš§ Audio/TTS functionality testing"
          echo "  ğŸš§ NPU driver support (if available)"
          echo "  ğŸš§ Performance optimization"
